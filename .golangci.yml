version: "2"

run:
  timeout: 5m
  tests: true

linters:
  default: 'none'
  enable:
    - errcheck
    - gocritic
    - gosec
    - govet
    - ineffassign
    - misspell
    - revive
    - staticcheck
    - unconvert
    - unparam

  settings:
    gocritic:
      disabled-tags:
        - experimental
        - opinionated
        - performance
    errcheck:
      exclude-functions:
        - (*database/sql.DB).Close
        - (*database/sql.Rows).Close
        - (*database/sql.Tx).Rollback
        - (*database/sql.Stmt).Close
        - (*database/sql.Conn).Close
        - (*os.File).Close
        - (os).RemoveAll
        - (os).Remove
        - (os).Setenv
        - (os).Unsetenv
        - (os).Chdir
        - (os).MkdirAll
        - (fmt).Sscanf
    misspell:
      locale: US
    staticcheck:
      checks:
        - "all"
        - "-QF*"   # Disable quick-fix suggestions (stylistic, low value)
        - "-ST1000" # Package comments are optional
        - "-ST1003" # NoDb naming matches YAML "no-db" tag convention
        - "-ST1020" # Exported comment format is stylistic
        - "-ST1022" # Var/const comment format is stylistic
    revive:
      rules:
        # Disable rules that are too noisy
        - name: exported
          disabled: true
        - name: package-comments
          disabled: true
        # Allow meaningful package names (utils is fine)
        - name: var-naming
          arguments:
            - []  # No extra initialisms
            - []  # No skip packages
            - - upperCaseConst: false  # Allow lowercase constants

  exclusions:
    rules:
      # G304: File inclusion via variable in tests is safe (test data)
      - path: '_test\.go'
        linters:
          - gosec
        text: "G304"
      # G306: File permissions 0644 in tests are acceptable (test fixtures)
      - path: '_test\.go'
        linters:
          - gosec
        text: "G306"
      # G115: Integer overflow checks not relevant in test contexts
      - path: '_test\.go'
        linters:
          - gosec
        text: "G115"
      # G404: Weak random is acceptable in tests (not security-critical)
      - path: '_test\.go'
        linters:
          - gosec
        text: "G404"
      # G204: Subprocess launches in tests are controlled test scenarios
      - path: '_test\.go'
        linters:
          - gosec
        text: "G204"
      # G302: Directory/file permissions in tests (test fixtures)
      - path: '_test\.go'
        linters:
          - gosec
        text: "G302"
      # G104: Unhandled errors in tests (test setup/teardown)
      - path: '_test\.go'
        linters:
          - gosec
        text: "G104"
      # G602: Slice bounds in tests are controlled scenarios
      - path: '_test\.go'
        linters:
          - gosec
        text: "G602"
      # G304: Safe file reads from known JSONL and error paths
      - path: 'cmd/bd/autoflush\.go|cmd/bd/daemon_autostart\.go|cmd/bd/doctor/fix/sync_branch\.go|cmd/bd/doctor/git\.go|cmd/bd/rename_prefix\.go|cmd/bd/sync_merge\.go|internal/beads/beads\.go|internal/daemon/discovery\.go|internal/daemonrunner/sync\.go|internal/syncbranch/worktree\.go|cmd/vibecli/lock\.go'
        linters:
          - gosec
        text: "G304"
      # G101: False positive on RPC operation constants (not credentials)
      - path: 'internal/rpc/protocol\.go'
        linters:
          - gosec
        text: "G101"
      # G302/G306: Directory/file permissions 0700/0750 are acceptable
      - linters:
          - gosec
        text: "G302.*0700|G301.*0750"
      # G302/G306: JSONL files and error logs need 0644 for debugging/sharing
      - path: 'cmd/bd/autoflush\.go|cmd/bd/daemon\.go|cmd/bd/daemon_sync_branch\.go|cmd/bd/resolve_conflicts\.go|cmd/bd/setup\.go|internal/daemon/registry\.go|internal/daemonrunner/daemon\.go|internal/git/worktree\.go'
        linters:
          - gosec
        text: "G306"
      # G306: Git hooks must be executable (0700)
      - path: 'cmd/bd/init\.go'
        linters:
          - gosec
        text: "G306.*0700"
      # G204: Safe subprocess launches with validated arguments
      - path: 'cmd/bd/daemon_autostart\.go|cmd/bd/daemon_sync_branch\.go|cmd/bd/doctor\.go|cmd/bd/doctor/fix/sync_branch\.go|cmd/bd/gate\.go|cmd/bd/gate_discover\.go|cmd/bd/jira\.go|cmd/bd/migrate_sync\.go|cmd/bd/show\.go|cmd/bd/sync\.go|internal/git/worktree\.go|internal/syncbranch/worktree\.go'
        linters:
          - gosec
        text: 'G204'
      # G104: Deferred file closes - errors are non-critical
      - path: 'cmd/bd/show\.go'
        linters:
          - gosec
        text: "G104.*Close"
      # G115: Safe integer conversions in backoff calculations
      - path: 'cmd/bd/daemon_autostart\.go'
        linters:
          - gosec
        text: "G115"
      # G201: SQL with fmt.Sprintf using placeholders (IN clause expansion)
      - path: 'internal/storage/sqlite/(dependencies|batch_ops)\.go'
        linters:
          - gosec
        text: "G201"
      # errcheck: Ignore unchecked errors in test files - tests commonly ignore errors
      # for setup/teardown operations where failure would cause test failure anyway
      - path: '_test\.go'
        linters:
          - errcheck
      # unparam: Test helper functions commonly have consistent signatures with
      # unused/constant parameters for API consistency across test cases
      - path: '_test\.go'
        linters:
          - unparam
      # staticcheck: Some checks are overly strict or less relevant in test code
      # SA1029: context keys can use string in tests (no collision risk)
      # SA4000/SA4006/SA5011: test-specific patterns that are acceptable
      # S1021: var declaration style is less critical in tests
      - path: '_test\.go'
        linters:
          - staticcheck
        text: "SA1019|SA1029|SA4000|SA4003|SA4006|SA5011|SA9003|S1021"

      # unparam: Placeholder functions that may return errors in future implementation
      - path: 'cmd/bd/jira\.go'
        linters:
          - unparam
        text: 'reimportConflicts|resolveConflictsByTimestamp'
      # misspell: "cancelled" is intentional - matching GitHub/Linear API response values
      # and test data that matches those APIs
      - linters:
          - misspell
        text: '[Cc]ancelled'
      # misspell: "portabel" is intentional test data for typo handling tests
      - path: 'internal/config/sync_test\.go'
        linters:
          - misspell
        text: 'portabel'
      # SA1019: Intentional use of deprecated field for backwards compatibility
      - path: 'cmd/bd/upgrade\.go'
        linters:
          - staticcheck
        text: "SA1019.*LastBdVersion"
      # ST1005: Multi-line error messages are intentional for user guidance
      - path: 'cmd/bd/(daemon_sync|init|jira|linear|staleness)\.go'
        linters:
          - staticcheck
        text: "ST1005"
      - path: 'internal/autoimport/autoimport\.go'
        linters:
          - staticcheck
        text: "ST1005"
      # SA5011: False positive - os.Exit(1) terminates, no nil dereference possible
      - path: 'cmd/bd/(daemons|swarm)\.go'
        linters:
          - staticcheck
        text: "SA5011"
      # revive: Stuttering names are intentional for clarity in these storage types
      - path: 'internal/storage/(sqlite|dolt)/store\.go'
        linters:
          - revive
        text: 'stutters'
      # revive: autoimport.AutoImportIfNewer is clearer than autoimport.IfNewer
      - path: 'internal/autoimport/autoimport\.go'
        linters:
          - revive
        text: 'stutters'
      # revive: "types", "util", "utils" are standard meaningful package names
      - path: 'internal/(types|util|utils)/'
        linters:
          - revive
        text: 'avoid meaningless package names'
      # revive: type_ uses underscore because "type" is a reserved keyword in Go
      - path: 'internal/types/types_test\.go'
        linters:
          - revive
        text: 'struct field type_'
      # gocritic: exitAfterDefer in CLI exit paths - process terminates so cleanup is skipped
      # intentionally (e.g., os.Exit after error in main command flows)
      - linters:
          - gocritic
        text: 'exitAfterDefer'
      # gocritic: ifElseChain is stylistic - some if-else chains are clearer than switches
      - linters:
          - gocritic
        text: 'ifElseChain'
      # gocritic: singleCaseSwitch - type assertions with single case are a common Go idiom
      - linters:
          - gocritic
        text: 'singleCaseSwitch'
      # gocritic: appendAssign - intentional new slice creation (not modifying original)
      # These patterns create new slices by combining or copying, not bugs:
      # - merge_slot.go: creates newWaiters to pass to update
      # - migrate_issues.go: combines upDeps and downDeps
      # - parser.go: creates copy of chain for error message
      # - server_issues_epics.go: combines gate waiters with new waiters
      # - cycle_detection_test.go: combines test cycle arrays
      # - queries.go: duplicates args for dependency IN clause (needs both sides)
      - path: 'cmd/bd/(merge_slot|migrate_issues)\.go|internal/formula/parser\.go|internal/rpc/server_issues_epics\.go|internal/storage/sqlite/(cycle_detection_test|queries)\.go'
        linters:
          - gocritic
        text: 'appendAssign'

issues:
  uniq-by-line: true

formatters:
  enable:
    - goimports
  settings:
    goimports:
      local-prefixes:
        - github.com/steveyegge/beads
