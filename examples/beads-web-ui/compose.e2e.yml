version: "3.8"

# E2E Testing Compose file for Podman
# Orchestrates daemon, web, and loom services for integration testing
#
# Usage:
#   podman-compose -f compose.e2e.yml up -d --build
#   podman-compose -f compose.e2e.yml down -v --remove-orphans

volumes:
  beads-data:  # Shared workspace volume for daemon socket and data

networks:
  e2e-network:
    driver: bridge

services:
  # beads daemon - creates socket and manages data
  # Note: Uses pre-built binaries via Containerfile.e2e.simple for disk efficiency
  # Before building, run from repo root:
  #   CGO_ENABLED=1 go build -ldflags '-linkmode external -extldflags "-static"' -o examples/beads-web-ui/bd-static ./cmd/bd
  #   CGO_ENABLED=0 go build -o examples/beads-web-ui/beads-web-ui-static ./examples/beads-web-ui
  daemon:
    build:
      context: .
      dockerfile: Containerfile.e2e.simple
      target: daemon
    volumes:
      - beads-data:/app/.beads
    healthcheck:
      test: ["CMD", "test", "-S", "/app/.beads/bd.sock"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - e2e-network
    restart: "no"

  # beads-web-ui - serves frontend and API on port 8080
  web:
    build:
      context: .
      dockerfile: Containerfile.e2e.simple
      target: web
    ports:
      - "8080:8080"
    volumes:
      - beads-data:/app/.beads
    environment:
      - BEADS_SOCKET=/app/.beads/bd.sock
      - LOOM_SERVER_URL=http://loom:9000
      - LOOM_PROXY_ALLOWED_HOSTS=loom
    depends_on:
      daemon:
        condition: service_healthy
      loom:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - e2e-network
    restart: "no"

  # loom server - agent monitoring service
  loom:
    build:
      context: ../..
      dockerfile: examples/beads-web-ui/Containerfile.e2e
      target: loom
    ports:
      - "9000:9000"
    volumes:
      - beads-data:/app/.beads
    environment:
      - LOOM_CORS_ORIGIN=*
    depends_on:
      daemon:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - e2e-network
    restart: "no"
